<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Safari / IE, cookies and iframe redirects - LARA Interactive API</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Safari / IE, cookies and iframe redirects";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> LARA Interactive API</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">LARA API</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Safari / IE, cookies and iframe redirects</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#safari-ie-cookies-and-iframe-redirects">Safari / IE, cookies and iframe redirects</a></li>
                
                    <li><a class="toctree-l4" href="#example">Example</a></li>
                
                    <li><a class="toctree-l4" href="#workarounds">Workarounds</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../about-mkdocs/">About the documentation generator</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">LARA Interactive API</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Safari / IE, cookies and iframe redirects</li>
    <li class="wy-breadcrumbs-aside">
      
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="safari-ie-cookies-and-iframe-redirects">Safari / IE, cookies and iframe redirects</h1>
<p>While recently debugging a weird authentication failure in an app that is regularly embedded within an iframe, I discovered some unexpected behavior in Safari and IE with respect to how it handles cookies for the sites within the iframe.</p>
<p>The TL;DR is this: <strong>Cookies will not be sent to the destination site of a 302 redirect</strong> (the destination defined in the HTTP Location header), regardless of whether or not you've previously visited that site (unless the site is within the same main domain as the redirecting site).</p>
<p>In Safari, most of this behavior is due to the recent change of default settings. Under <em>Privacy</em> -&gt; <em>Cookies and website data</em>, the setting changed from <em>Allow from websites I visit</em> to <em>Allow from current website only</em>.</p>
<p>There doesn't seem to be a setting around this behavior in IE.</p>
<h2 id="example">Example</h2>
<p>Our app uses OAuth2 to sign in via a different app. The sign in process involves several redirects (these aren't the actual domains/paths, but roughly the same steps):</p>
<pre><code>Request                            Response
GET:  https://app.com/login        302: https://sso.com/sso/login
GET:  https://sso.com/sso/login    200
POST: https://sso.com/sso/login    302: https://app.com/sso/callback
GET:  https://app.com/sso/callback 302: https://app.com/
</code></pre>
<p>This all works fine in Safari when accessing app.com in a top-level window. However, this all breaks down when running within an iframe.</p>
<p>It turns out that Safari will <em>not</em> send cookies to <em>sso.com</em> in the 2nd request, and additionally will <em>not</em> send cookies to <em>app.com</em> in the 4th request. The whole sign in process relies on maintaining consistent sessions, so when no cookies are sent, the sign in doesn't take, and the user is left on app.com in a logged out state.</p>
<h2 id="workarounds">Workarounds</h2>
<ol>
<li>
<p>I haven't been able to test this, but supposedly you can work around this cookie behavior by rendering a page which redirects via the page content, rather than redirecting via a 302 response with a <em>Location</em> header.</p>
<pre><code>&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Sign In&lt;/title&gt;
    &lt;meta http-equiv="refresh" content="0;URL='https://sso.com/sso/login'" /&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;p&gt;This page has moved to a &lt;a href="https://sso.com/sso/login"&gt;new location&lt;/a&gt;.&lt;/p&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>However, you'll have to take care that the request to the other site is essentially the same (Referrer, Origin, etc all present the same info).</p>
</li>
<li>
<p>Also, Safari's definition of <em>current website</em> is a bit loose when it comes to the hostname. foo.app.com is considered the same site as bar.app.com. We were fortunate enough to be able to use this tactic to bring our app into the same "site" as the sso provider, but that's not usually possible when working with a 3rd-party provider.</p>
</li>
<li>
<p>If your redirecting code makes a full round-trip, another option is to do all of your redirecting in a separate window. Use Javascript to open a window, and then monitor its url. Once the url is back to the location you're expecting, close the window and reload the iframe page.</p>
<p>The library is here:</p>
<pre><code>// A wrapper around having an external link pop up in its own window, and then automatically monitoring it
// and closing it when it returns to the same domain as the current page.

window.inIframe = function() {
  try {
      return window.self !== window.top;
  } catch (e) {
      return true;
  }
};

window.AutomaticallyClosingPopupLink = {
  configure: function($link, directUrl, popupUrl, afterCloseUrl) {
    var onClick = function() {
      if (window.inIframe()) {
        // Pop up the url in a new window
        // Monitor it and close it when done
        // Redirect the current page when closed
        this._popupWindow($link.id, popupUrl, afterCloseUrl);
      } else {
        window.location.href = directUrl;
      }
    }.bind(this);
    $link.on('click', onClick);
  },

  // This code was adapted from CODAP's implementation of a similar feature
  _popupWindow: function(id, popupUrl, afterCloseUrl) {
    var width  = 800,
        height = 480,
        position = this._computeScreenLocation(width, height),
        windowFeatures = [
          'width=' + width,
          'height=' + height,
          'top=' + position.top || 200,
          'left=' + position.left || 200,
          'dependent=yes',
          'resizable=no',
          'location=no',
          'dialog=yes',
          'menubar=no'
        ],
        exceptionCount = 0,
        panel = window.open(popupUrl, id, windowFeatures.join()),
        checkPanelHref = function() {
          try {
            /* This is a bit of a hack. Accessing a popup's location throws a security exception
             * when the url is cross-origin. Therefore, 1) this should only be used with urls that are         cross-origin, and 2) the url
             * should eventually return to a non-cross-origin url at the time the window should be closed.
             */
            var href = panel.location.href; // This will throw an exception if the url is still cross-origin.

            // If exceptionCount is not 0, then we hit an external url and came back. Assume that we're done.
            // If it's still 0, then keep waiting for the url to change to something external and change back.
            if (exceptionCount &gt; 0) {
              window.clearInterval(timer);
              panel.close();
              if (afterCloseUrl) {
                document.location = afterCloseUrl;
              } else {
                document.location.reload();
              }
            }
          } catch(e) {
            exceptionCount++;
          }
        },
        timer = window.setInterval(checkPanelHref, 200);
  },

  _computeScreenLocation: function(w, h) {
    // Fixes dual-screen position                         Most browsers      Firefox
    var dualScreenLeft = window.screenLeft !== undefined ? window.screenLeft : screen.left;
    var dualScreenTop = window.screenTop !== undefined ? window.screenTop : screen.top;

    var width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ?         document.documentElement.clientWidth : screen.width;
    var height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

    var left = ((width / 2) - (w / 2)) + dualScreenLeft;
    var top = ((height / 2) - (h / 2)) + dualScreenTop;
    return {left: left, top: top};
  }
};
</code></pre>
<p>And it's used via this code in the page:</p>
<pre><code>jQuery(function() {
  var button = jQuery('#login_button'),
      path = '/login',
      popup = '/popupLogin',
      redirect = '/';

  window.AutomaticallyClosingPopupLink.configure(button, path, popup, redirect);
});
</code></pre>
</li>
</ol>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../about-mkdocs/" class="btn btn-neutral float-right" title="About the documentation generator"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="LARA API"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../about-mkdocs/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
